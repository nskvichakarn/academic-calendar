<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</title>
  
<link rel="icon" type="image/png" href="./logo.png">
<link rel="apple-touch-icon" href="./logo.png">

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
  :root{ --grad-start:#93c5fd; --grad-end:#e0f2fe; }
  html,body{height:100%}
  body{font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',"Noto Sans Thai",sans-serif;}
  .bg-grad{ background:linear-gradient(135deg,var(--grad-start),var(--grad-end)); }
  .card{ background:#fff; border-radius:22px; box-shadow:0 10px 30px rgba(15,23,42,.08), 0 2px 8px rgba(15,23,42,.06); }
  .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .9rem; border-radius:14px; background:#fff; box-shadow:0 6px 16px rgba(15,23,42,.06); }
  .btn:hover{ background:#f8fafc }
  .btn-primary{ background:linear-gradient(135deg,#38bdf8,#3b82f6); color:#fff; }
  .btn-primary:hover{ filter:brightness(1.05) }
  .grid-7{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.5rem; }
  .mini-7{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.25rem; }
  .dow{ text-align:center; font-weight:600; color:#334155 }
  .day{ min-height:110px; position:relative; padding:.55rem; border-radius:16px; background:#fff; }
  .day.sat{ background:rgba(147,197,253,.25) }
  .day.sun{ background:rgba(239,68,68,.15) }
  .day .num{ position:absolute; top:.5rem; right:.6rem; font-weight:600; color:#334155 }
  .today-badge{ position:absolute; top:.5rem; right:2.2rem; background:linear-gradient(135deg,#0ea5e9,#38bdf8); color:#fff; padding:.05rem .45rem; border-radius:999px; font-size:.7rem; font-weight:700; }
  .chip{ display:block; font-size:.78rem; padding:.18rem .45rem; border-radius:12px; background:#f0f9ff; color:#0369a1; margin:.22rem 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .chip:hover{ background:#e0f2fe }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; background:rgba(15,23,42,.35); backdrop-filter:blur(3px); }
  .modal.show{ display:grid; }
  .modal-card{ width:min(920px,92vw); background:#fff; border-radius:20px; padding:1.25rem; }
  /* ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏°‡∏î‡∏±‡∏• ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.modal { overscroll-behavior: contain; }
.modal-card{
  max-height: 88vh;          /* ‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
  overflow: auto;            /* ‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏•‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ */
  -webkit-overflow-scrolling: touch; /* ‡∏•‡∏∑‡πà‡∏ô‡∏ö‡∏ô iOS */
}

/* ‡∏•‡πá‡∏≠‡∏Å body ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏• */
.body-lock { overflow: hidden; height: 100vh; }

/* (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏•‡∏≠‡∏î */
#tab-add .mt-4.flex,
#tab-edit .md\:col-span-2.flex{
  position: sticky; bottom: 0;
  background: #fff; padding: .75rem 0; margin-top: 1rem;
  border-top: 1px solid #e5e7eb;
}
  .field{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .8rem; }
  .tab{ padding:.45rem .8rem; border-radius:12px; cursor:pointer; }
  .tab.active{ background:#e0f2fe; color:#0369a1; font-weight:600; }
  @media (max-width:640px){ .day{ min-height:95px } .chip{ font-size:.7rem } }
/* ‡πÇ‡∏ó‡∏ô‡∏ü‡πâ‡∏≤‡∏ô‡∏° ‡∏ô‡∏∏‡πà‡∏°‡∏ï‡∏≤ */
:root{
  --milk-1:#aec8ff;   /* ‡∏ü‡πâ‡∏≤‡∏ô‡∏°‡∏≠‡πà‡∏≠‡∏ô */
  --milk-2:#6b8cff;   /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏° */
  --milk-sat-1:#bed0ff;
  --milk-sat-2:#5b7dff;
  --milk-sun-1:#ffd1d1; /* ‡∏ä‡∏°‡∏ô‡∏°‡∏ô‡∏¥‡∏î‡πÜ */
  --milk-sun-2:#ff8a8a;
}

/* ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô */
.day.has-event:not(.sat):not(.sun){
  background: linear-gradient(135deg,var(--milk-1),var(--milk-2)) !important;
  color:#fff !important;
  box-shadow: 0 10px 24px rgba(59,130,246,.22), inset 0 1px 0 rgba(255,255,255,.25) !important;
  border: 1px solid rgba(255,255,255,.25) !important;
}

/* ‡πÄ‡∏™‡∏≤‡∏£‡πå/‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏°‡∏µ‡∏á‡∏≤‡∏ô */
.day.sat.has-event{
  background: linear-gradient(135deg,var(--milk-sat-1),var(--milk-sat-2)) !important;
  color:#fff !important;
  box-shadow: 0 10px 24px rgba(59,130,246,.20) !important;
  border: 1px solid rgba(255,255,255,.25) !important;
}
.day.sun.has-event{
  background: linear-gradient(135deg,var(--milk-sun-1),var(--milk-sun-2)) !important;
  color:#fff !important;
  box-shadow: 0 10px 24px rgba(255,120,120,.22) !important;
  border: 1px solid rgba(255,255,255,.25) !important;
}

/* ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
.day.has-event .num{ color:#fff !important; }
.day.has-event .chip{ background:rgba(255,255,255,.20) !important; color:#fff !important; }

/* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏ä‡∏¥‡∏õ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
.day.has-event .num{ color:#fff; }
.day.has-event .chip{ background:rgba(255,255,255,.22); color:#fff; }
/* ===== ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå / ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© ===== */
.day.holiday{
  background: linear-gradient(135deg,#f59e0b,#b45309); /* ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°/‡∏ô‡∏°‡πÜ */
  color:#fff;
  font-weight:700;
  box-shadow:0 6px 18px rgba(180,83,9,.25);
}
.day.holiday .num{ color:#fff; }
.day.holiday .chip{ background:rgba(255,255,255,.24); color:#fff; }
/* ===== ‡∏™‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ===== */
.day.holiday--religion{  /* ‡∏ß‡∏±‡∏ô‡∏®‡∏≤‡∏™‡∏ô‡∏≤ */
  background: linear-gradient(135deg,#fbbf24,#b45309) !important;  /* ‡∏ó‡∏≠‡∏á‡∏™‡πâ‡∏° */
  color:#fff !important;
}
.day.holiday--royal{     /* ‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå */
  background: linear-gradient(135deg,#c4b5fd,#7c3aed) !important;  /* ‡∏°‡πà‡∏ß‡∏á */
  color:#fff !important;
}
.day.holiday--national{  /* ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£/‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
  background: linear-gradient(135deg,#6ee7b7,#0f766e) !important;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ô‡∏° */
  color:#fff !important;
}

/* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç/‡∏ä‡∏¥‡∏õ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
.day.holiday .num{color:#fff!important}
.day.holiday .chip{background:rgba(255,255,255,.22)!important;color:#fff!important}
/* ‡∏ñ‡πâ‡∏≤‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏™‡∏≤‡∏£‡πå/‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î‡∏™‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î */
.day.sat.holiday, .day.sun.holiday{ background: linear-gradient(135deg,#f59e0b,#b45309); }
/* ===== ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ===== */
@media (max-width: 480px){
  .grid-7{ gap:.35rem; }
  .day{
    min-height:84px;            /* ‡∏¢‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
    padding:.5rem .55rem;
    border-radius:16px;
  }
  .day .num{                    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î */
    right:.55rem;
    font-weight:700;
  }
  .today-badge{                 /* ‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏ï‡∏≤ */
    top:auto; right:.55rem; bottom:.45rem;
    font-size:.68rem; padding:.08rem .4rem;
  }
  .chip{                        /* ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ä‡∏¥‡∏õ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    display:none !important;
  }
  /* ‡∏à‡∏∏‡∏î‡∏ö‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô */
  .mobile-dots{
    position:absolute; left:.55rem; bottom:.5rem;
    display:flex; align-items:center; gap:.25rem;
    font-size:.72rem; color:#0ea5e9;
  }
  .dot{width:6px;height:6px;border-radius:999px;background:#0ea5e9;opacity:.85}
  .count-badge{
    font-variant-numeric: tabular-nums;
    padding:0 .3rem; border-radius:6px; background:#e0f2fe;
  }

  /* ‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‚Üí ‡∏™‡∏µ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  .day.has-event{ box-shadow:0 6px 16px rgba(2,132,199,.15) }
}

/* Desktop/Tablet ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≤‡∏•‡∏á */
@media (min-width: 481px){
  .chip{ display:flex }
}
/* --- Mobile-first calendar tweaks --- */
@media (max-width: 640px){
  .card{ border-radius:16px; box-shadow:0 6px 18px rgba(15,23,42,.06) }
  .day{ min-height:84px; padding:.5rem; border-radius:14px }
  .day .num{ font-size:.95rem; right:.45rem; top:.45rem }
  .chip{ font-size:.72rem; padding:.14rem .4rem; border-radius:10px }
  /* ‡∏ã‡πà‡∏≠‡∏ô ‚Äú‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏ó‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏Å‡∏ï‡∏≤) */
  .day .no-items{ display:none }
  .day.no-event::after{
    content:'‚Ä¢'; position:absolute; left:.5rem; bottom:.45rem; opacity:.25; font-size:1rem;
  }
  /* ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
  #currentMonthLabel{ min-width:auto; padding:.4rem .8rem }
  .btn{ padding:.4rem .7rem; border-radius:12px }
}
/* ==== ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô ==== */

/* ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô */
.day.has-event:not(.sat):not(.sun){
  background: linear-gradient(135deg, #2563eb, #1e3a8a) !important; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
  color:#fff !important;
  font-weight:600;
  box-shadow:0 6px 16px rgba(30,58,138,.35) !important;
}

/* ‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô */
.day.sat.has-event{
  background: linear-gradient(135deg, #0891b2, #155e75) !important; /* ‡∏ü‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏• */
  color:#fff !important;
  box-shadow:0 6px 16px rgba(8,145,178,.35) !important;
}

/* ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô */
.day.sun.has-event{
  background: linear-gradient(135deg, #f87171, #b91c1c) !important; /* ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° */
  color:#fff !important;
  box-shadow:0 6px 16px rgba(185,28,28,.35) !important;
}

/* ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
.day.has-event .num{ color:#fff !important; }
.day.has-event .chip{ background: rgba(255,255,255,.22) !important; color:#fff !important; }
/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ß‡∏±‡∏ô‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ) */
#yearGrid .card .has-event{ background:#dbeafe } /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ß‡∏£‡∏≤‡∏¢‡∏õ‡∏µ */
/* ===== ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå / ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© ===== */
.day.holiday{
  background: linear-gradient(135deg,#f59e0b,#b45309) !important; /* ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°/‡∏ô‡∏°‡πÜ */
  color:#fff !important;
  font-weight:700;
  box-shadow:0 6px 18px rgba(180,83,9,.25);
}
.day.holiday .num{ color:#fff; }
.day.holiday .chip{ background:rgba(255,255,255,.24); color:#fff; }

/* ‡∏ñ‡πâ‡∏≤‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏™‡∏≤‡∏£‡πå/‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î‡∏™‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î */
.day.sat.holiday, .day.sun.holiday{ background: linear-gradient(135deg,#f59e0b,#b45309); }
/* --- ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô) --- */
.day.sat{
  background: #fff0f5 !important;      /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
}
.day.sun{
  background: #fff4e5 !important;      /* ‡∏™‡πâ‡∏°‡∏û‡∏µ‡∏ä‡∏≠‡πà‡∏≠‡∏ô */
}

/* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
.day.sat .num{ color:#9b2c2c !important; }  /* ‡πÇ‡∏ó‡∏ô‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
.day.sun .num{ color:#b45309 !important; }  /* ‡πÇ‡∏ó‡∏ô‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏° */

/* --- ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‚Äú‡∏°‡∏µ‡∏á‡∏≤‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î --- */
.day.sat.has-event{
  background: linear-gradient(135deg,#f9a8d4,#ec4899) !important; /* ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏î */
  color:#fff !important;
}
.day.sun.has-event{
  background: linear-gradient(135deg,#fbbf24,#f59e0b) !important; /* ‡∏ó‡∏≠‡∏á‡∏™‡πâ‡∏°‡∏™‡∏î */
  color:#fff !important;
}
.day.sat.has-event .num,
.day.sun.has-event .num{ color:#fff !important; }
.day.sat.has-event .chip,
.day.sun.has-event .chip{ background:rgba(255,255,255,.22) !important; color:#fff !important; }

/* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‚Äù ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏ô‡∏∞‡πÄ‡∏™‡∏°‡∏≠ */
.day.sat.holiday, .day.sun.holiday{
  background: linear-gradient(135deg,#f59e0b,#b45309) !important;
  color:#fff !important;
}
/* === Emoji Picker === */
.emoji-modal{ position:fixed; inset:0; display:none; place-items:center; z-index:60;
  background:rgba(15,23,42,.35); backdrop-filter:blur(3px); }
.emoji-modal.show{ display:grid; }
.emoji-box{ width:min(680px,92vw); background:#fff; border-radius:16px; padding:12px; }
.emoji-grid{ display:grid; grid-template-columns:repeat(10, 1fr); gap:6px; }
.emoji-item{ font-size:22px; display:grid; place-items:center; padding:8px; border-radius:10px;
  cursor:pointer; border:1px solid #e5e7eb; }
.emoji-item:hover{ background:#f1f5f9; }
.emoji-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
.emoji-tabs{ display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 10px }
.emoji-tab{ padding:.25rem .55rem; border-radius:999px; background:#f1f5f9; cursor:pointer; font-size:.9rem }
.emoji-tab.active{ background:#dbeafe; color:#1d4ed8; font-weight:600 }
.emoji-search{ width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .75rem; margin-bottom:10px }
.emoji-trigger{ display:flex; align-items:center; gap:.5rem; }
.emoji-trigger .preview{ width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:#f1f5f9 }
@media (max-width:520px){ .emoji-grid{ grid-template-columns:repeat(7,1fr) } }

/* === ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á === */
/* ‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® */
.marquee-wrap { overflow: hidden; white-space: nowrap; position: relative; }
.marquee-text { display: inline-block; padding-left: 100%; animation: scroll-left 20s linear infinite; }
@keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡πÇ‡∏ó‡∏ô‡∏™‡πâ‡∏°/‡∏ä‡∏°‡∏û‡∏π ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤) */
.countdown-card {
  background: linear-gradient(135deg, #fff1f2, #ffe4e6); /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
  border: 1px solid #fecdd3;
}
.cd-box {
  background: rgba(255,255,255,0.6); backdrop-filter: blur(4px);
  border-radius: 12px; padding: 0.35rem 0.5rem; min-width: 55px; text-align: center;
}
.cd-num { font-weight: 700; color: #e11d48; font-size: 1.1rem; line-height: 1.2; }
.cd-label { font-size: 0.65rem; color: #9f1239; }
</style>
</head>
<body class="bg-grad text-slate-800">

<header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
  <div class="card p-5 flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <img src="./logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" style="width:64px;height:64px;object-fit:contain;border-radius:12px;">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h1>
        <p class="text-slate-500 text-sm">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢ (‡∏û.‡∏®.)</p>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <span class="px-3 py-1 rounded-full bg-white/70 card">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: <b id="connStatus">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</b></span>
      <span class="px-3 py-1 rounded-full bg-white/70 card">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b></span>
      <span class="px-3 py-1 rounded-full bg-white/70 card">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b id="countMonth">0</b></span>
      <span class="px-3 py-1 rounded-full bg-white/70 card">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b id="countToday">0</b></span>
    </div>
  </div>
</header>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
  <div class="card p-4 flex flex-col lg:flex-row items-center justify-between gap-3">
    <div class="flex flex-wrap gap-2">
      <button id="btnViewMonth" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button id="btnViewList" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <button id="btnViewYear" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnPrev" class="btn">‚Äπ</button>
      <div id="currentMonthLabel" class="px-4 py-2 rounded-2xl text-white font-semibold card" style="background:linear-gradient(135deg,#38bdf8,#3b82f6);min-width:220px;text-align:center">‚Äì</div>
      <button id="btnNext" class="btn">‚Ä∫</button>
      <button id="btnToday" class="btn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <div class="flex flex-wrap gap-2">
      <button id="btnSync" class="btn">‡∏ã‡∏¥‡∏á‡∏Å‡πå Google Sheets</button>
      <button id="btnAdmin" class="btn btn-primary">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    </div>
  </div>
</div>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 pb-24">
  <div class="mb-5 space-y-4">
  
  <div class="card p-2 flex items-center gap-3 overflow-hidden bg-white/90 border border-slate-100">
    <div class="flex-shrink-0 px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-lg animate-pulse">
      üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô
    </div>
    <div class="marquee-wrap w-full text-sm text-slate-600">
      <div class="marquee-text" id="announceText">
        ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£... ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 1
      </div>
    </div>
  </div>

  <div class="card countdown-card p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <div class="text-3xl">‚è≥</div>
      <div>
        <h3 class="font-bold text-slate-800 text-lg" id="cdTitle">‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏™‡∏π‡πà‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</h3>
        <p class="text-xs text-slate-500" id="cdSub">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°!</p>
      </div>
    </div>
    
    <div class="flex gap-2">
      <div class="cd-box">
        <div class="cd-num" id="cd-d">-</div><div class="cd-label">‡∏ß‡∏±‡∏ô</div>
      </div>
      <div class="cd-box">
        <div class="cd-num" id="cd-h">-</div><div class="cd-label">‡∏ä‡∏°.</div>
      </div>
      <div class="cd-box">
        <div class="cd-num" id="cd-m">-</div><div class="cd-label">‡∏ô‡∏≤‡∏ó‡∏µ</div>
      </div>
      <div class="cd-box">
        <div class="cd-num" id="cd-s">-</div><div class="cd-label">‡∏ß‡∏¥</div>
      </div>
    </div>
  </div>

</div>
  <section id="view-month" class="space-y-3">
    <div class="grid-7">
      <div class="dow">‡∏≠‡∏≤</div><div class="dow">‡∏à</div><div class="dow">‡∏≠</div><div class="dow">‡∏û</div><div class="dow">‡∏û‡∏§</div><div class="dow">‡∏®</div><div class="dow">‡∏™</div>
    </div>
    <div id="monthGrid" class="grid-7"></div>
    <details class="card p-4">
      <summary class="cursor-pointer font-semibold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</summary>
      <div id="monthList" class="mt-3 space-y-2"></div>
    </details>
  </section>

  <section id="view-list" class="hidden space-y-3">
    <div class="card p-4 flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
      <div class="flex-1">
        <label class="text-sm text-slate-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <input id="searchInput" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‚Ä¶">
      </div>
      <div class="flex items-end gap-3">
        <div>
          <label class="text-sm text-slate-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <select id="filterMonth" class="field"></select>
        </div>
        <div>
          <label class="text-sm text-slate-600">‡∏õ‡∏µ (‡∏û.‡∏®.)</label>
          <select id="filterYear" class="field"></select>
        </div>
      </div>
    </div>
    <div id="listContainer" class="card p-4"></div>
  </section>

  <section id="view-year" class="hidden">
    <div id="yearGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>
</main>
<!-- Emoji Picker -->
<div id="emojiPicker" class="emoji-modal" aria-hidden="true">
  <div class="emoji-box card">
    <div class="emoji-head">
      <div class="text-slate-700 font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</div>
      <button class="btn" id="emojiCloseBtn">‡∏õ‡∏¥‡∏î</button>
    </div>
    <input id="emojiSearch" class="emoji-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‡∏Å‡∏µ‡∏¨‡∏≤ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‚Ä¶">
    <div id="emojiTabs" class="emoji-tabs"></div>
    <div id="emojiGrid" class="emoji-grid"></div>
  </div>
</div>
<!-- Day modal -->
<div id="modal-day" class="modal">
  <div class="modal-card">
    <div class="flex items-start justify-between">
      <div>
        <h3 id="modalDayTitle" class="text-lg font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Ä¶</h3>
        <p id="modalDaySub" class="text-slate-500 text-sm"></p>
      </div>
      <button class="btn" onclick="closeDayModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="modalDayList" class="mt-4 space-y-3"></div>
  </div>
</div>

<!-- Detail modal -->
<div id="modal-detail" class="modal">
  <div class="modal-card">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-2">
        <div id="detailEmoji" class="text-2xl">üìö</div>
        <h3 id="detailTitle" class="text-lg font-semibold"></h3>
      </div>
      <button class="btn" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="detailBody" class="mt-3 text-sm space-y-2"></div>
    <div class="mt-4 flex gap-2" id="detailAdminBtns" style="display:none">
      <button class="btn" id="btnEditInDetail">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn" id="btnDeleteInDetail">‡∏•‡∏ö</button>
    </div>
  </div>
</div>

<!-- Admin modal -->
<div id="modal-admin" class="modal">
  <div class="modal-card">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</h3>
      <button class="btn" onclick="closeAdminModal()">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div class="mt-4 bg-slate-50 rounded-2xl p-2 flex flex-wrap gap-2">
      <div class="tab active" data-tab="add">‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
      <div class="tab" data-tab="edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
      <div class="tab" data-tab="delete">‡∏•‡∏ö</div>
      <div class="ml-auto text-slate-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b id="adminConn">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</b></div>
    </div>
<!--‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete -->
  <datalist id="staffList"></datalist>
<!--‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete -->
  <datalist id="locationList"></datalist>
    <!-- ADD -->
    <div id="tab-add" class="mt-4">
      <div class="grid md:grid-cols-2 gap-3">
        <div><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input id="add-title" class="field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏õ‡∏ê‡∏°‡∏ô‡∏¥‡πÄ‡∏ó‡∏®"></div>
        <div><label class="text-sm">‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><select id="add-emoji" class="field"></select></div>

        <div class="md:col-span-2">
          <label class="text-sm">‡πÇ‡∏´‡∏°‡∏î</label>
          <div class="flex gap-3">
            <label class="flex items-center gap-2"><input type="radio" name="add-mode" value="single" checked>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
            <label class="flex items-center gap-2"><input type="radio" name="add-mode" value="range">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</label>
          </div>
        </div>

        <div id="add-single-wrap"><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="add-date" type="date" class="field"></div>
        <div id="add-range-wrap" class="grid grid-cols-2 gap-3 hidden">
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="add-startDate" type="date" class="field"></div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="add-endDate" type="date" class="field"></div>
        </div>

        <div><label class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="add-startTime" type="time" class="field"></div>
        <div><label class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="add-endTime" type="time" class="field"></div>

        <div><label class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><input id="add-location" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" list="locationList"></div>
        <div class="md:col-span-2">
  <label class="text-sm">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
  <input id="add-owner" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô" list="staffList">
</div>

        <div class="md:col-span-2"><label class="text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="add-details" class="field" rows="3"></textarea></div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="btnAddConfirm" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="btnAddReset" class="btn">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </div>

    <!-- EDIT -->
    <div id="tab-edit" class="mt-4 hidden">
      <div class="text-sm text-slate-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
      <select id="edit-select" class="field mb-3"></select>
      <div id="edit-form" class="grid md:grid-cols-2 gap-3 hidden">
        <div><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input id="edit-title" class="field"></div>
        <div><label class="text-sm">‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><select id="edit-emoji" class="field"></select></div>

        <div class="md:col-span-2">
          <label class="text-sm">‡πÇ‡∏´‡∏°‡∏î</label>
          <div class="flex gap-3">
            <label class="flex items-center gap-2"><input type="radio" name="edit-mode" value="single">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
            <label class="flex items-center gap-2"><input type="radio" name="edit-mode" value="range">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</label>
          </div>
        </div>

        <div id="edit-single-wrap"><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="edit-date" type="date" class="field"></div>
        <div id="edit-range-wrap" class="grid grid-cols-2 gap-3 hidden">
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="edit-startDate" type="date" class="field"></div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="edit-endDate" type="date" class="field"></div>
        </div>

        <div><label class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="edit-startTime" type="time" class="field"></div>
        <div><label class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="edit-endTime" type="time" class="field"></div>
        <div><label class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><input id="edit-location" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" list="locationList"></div>
        <div class="md:col-span-2">
  <label class="text-sm">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
  <input id="edit-owner" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô" list="staffList">
</div>
        <div class="md:col-span-2"><label class="text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="edit-details" class="field" rows="3"></textarea></div>
        <div class="md:col-span-2 flex gap-2">
          <button id="btnEditSave" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button id="btnEditCancel" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>

    <!-- DELETE -->
    <div id="tab-delete" class="mt-4 hidden">
      <div class="text-sm text-slate-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö</div>
      <select id="delete-select" class="field mb-3"></select>
      <button id="btnDeleteConfirm" class="btn" style="background:#ef4444;color:#fff">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="loading" class="modal"><div class="modal-card text-center">
  <div class="mx-auto mb-2 w-10 h-10 rounded-full border-4 border-sky-400 border-t-transparent animate-spin"></div>
  <div class="text-slate-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
</div></div>

<script>
/* ================= CONFIG ================= */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyuYWWhdRW5hT7LIdYb3XOrq5hwNaDI_4yeMoHFSw6GLPx3ukUo4SVNzkC17HnMCaUy/exec';
const ADMIN_PASSWORD = 'admin1234';
const CACHE_KEY = 'nsph_events_cache_v1';
const CACHE_AT  = 'nsph_events_cache_at_v1';

function lockBody(v){
  $('body').toggleClass('body-lock', !!v);
}
/* ===== ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏ö‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏â‡∏ö‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ===== */
const EMOJI_GROUPS = {
  "üè´ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á / ‡∏û‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£": ["üè´","üîî","üéñÔ∏è","üéóÔ∏è","ü™Ñ","üì¢","üáπüá≠"],
  "üìò ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ / ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ": ["üéì","üìö","‚úèÔ∏è","üìù","üß†","üßÆ","üî¨","üß™","üß¨","üñ•Ô∏è"],
  "üß™ ‡∏™‡∏≠‡∏ö / ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô": ["üß™","üìù","üßæ","üìä","‚úÖ","üìà","‚è≥"],
  "üèüÔ∏è ‡∏Å‡∏µ‡∏¨‡∏≤ / ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô": ["üèüÔ∏è","üèÜ","ü•á","ü•à","ü•â","‚öΩ","üèê","üèÄ","üèÉ‚Äç‚ôÇÔ∏è","ü§∏‚Äç‚ôÄÔ∏è"],
  "üöå ‡∏ó‡∏±‡∏®‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏Ñ‡πà‡∏≤‡∏¢": ["üöå","üöÜ","‚úàÔ∏è","üéí","üèïÔ∏è","üß≠","üó∫Ô∏è","üèñÔ∏è"],
  "üë• ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° / ‡∏≠‡∏ö‡∏£‡∏°": ["üë•","üßë‚Äçüè´","üë©‚Äçüè´","üó£Ô∏è","üñäÔ∏è","üóìÔ∏è","üìÖ","ü™ë"],
  "üìÇ ‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£": ["üìÇ","üìÑ","üìë","üìå","üóÇÔ∏è","üñáÔ∏è","‚úâÔ∏è","üì†"],
  "üåæ ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå / ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£": ["üåæ","ü§ù","üèòÔ∏è","üåø","üå±","üå≥","üßë‚Äçüåæ","üß∞"],
  "ü©∫ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢": ["ü©∫","üíä","üßØ","üöë","ü¶∫","üßº","üò∑"],
  "üé≠ ‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏° / ‡∏î‡∏ô‡∏ï‡∏£‡∏µ": ["üé≠","üé®","üñºÔ∏è","üé∂","üé§","üéº","ü™ò","üï∫"],
  "üõï ‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç / ‡∏®‡∏≤‡∏™‡∏ô‡∏≤": ["üõï","üôè","üïØÔ∏è","üåï","üíê","üïäÔ∏è"],
  "‚ú® ‡∏û‡∏¥‡πÄ‡∏®‡∏© / ‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏â‡∏•‡∏≠‡∏á": ["üéâ","üéä","üéà","üç∞","üç≠","üéÇ","üéá","üéÜ"]
};
const LOCATIONS = ["(‡πÑ‡∏°‡πà‡∏°‡∏µ)","‡∏´‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏®‡∏¥‡∏•‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤","‡πÇ‡∏£‡∏á‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô","‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•","‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•","‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ","‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏´‡πâ‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ","‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©","‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î"];
const OWNERS = ["‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•","‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];

/* ===== ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå/‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏õ‡∏µ 2568 (‡∏Ñ.‡∏®. 2025) =====
   ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD (‡∏Ñ.‡∏®.) ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ */
const HOLIDAYS = [
  {date:'2025-01-01', name:'‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà', type:'national'},
  {date:'2025-02-12', name:'‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},
  {date:'2025-04-06', name:'‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏µ', type:'royal'},
  {date:'2025-04-07', name:'‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏µ', type:'royal'},
  {date:'2025-04-13', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2025-04-14', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2025-04-15', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2025-04-16', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå (‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏î‡πÄ‡∏ä‡∏¢)', type:'national'},
  {date:'2025-05-01', name:'‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥ (‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô‡∏´‡∏¢‡∏∏‡∏î)', type:'national'},
  {date:'2025-05-04', name:'‡∏ß‡∏±‡∏ô‡∏â‡∏±‡∏ï‡∏£‡∏°‡∏á‡∏Ñ‡∏•', type:'national'},
  {date:'2025-05-05', name:'‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ß‡∏±‡∏ô‡∏â‡∏±‡∏ï‡∏£‡∏°‡∏á‡∏Ñ‡∏•', type:'national'},
  {date:'2025-05-11', name:'‡∏ß‡∏¥‡∏™‡∏≤‡∏Ç‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},
  {date:'2025-05-12', name:'‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ß‡∏¥‡∏™‡∏≤‡∏Ç‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},

  {date:'2025-06-02', name:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', type:'royal'},
  {date:'2025-06-03', name:'‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏†‡∏û ‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏™‡∏∏‡∏ó‡∏¥‡∏î‡∏≤', type:'royal'},

  {date:'2025-07-10', name:'‡∏≠‡∏≤‡∏™‡∏≤‡∏¨‡∏´‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},

  {date:'2025-07-28', name:'‡∏ß‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏û‡∏£‡∏£‡∏©‡∏≤ ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 10', type:'royal'},

  {date:'2025-08-11', name:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', type:'royal'},
  {date:'2025-08-12', name:'‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', type:'royal'},

  {date:'2025-10-13', name:'‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï ‡∏£.9', type:'royal'},
  {date:'2025-10-23', name:'‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏¢‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä', type:'royal'},

  {date:'2025-12-05', name:'‡∏ß‡∏±‡∏ô‡∏û‡πà‡∏≠‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', type:'royal'},
  {date:'2025-12-10', name:'‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç', type:'national'},
  {date:'2025-12-31', name:'‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ', type:'national'},

  {date:'2026-01-01', name:'‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà', type:'national'},
  {date:'2026-01-02', name:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', type:'national'},
  {date:'2026-01-16', name:'‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏π', type:'national'},
  {date:'2026-02-03', name:'‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},
  {date:'2026-04-06', name:'‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏µ', type:'royal'},
  {date:'2026-04-13', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2026-04-14', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2026-04-15', name:'‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå', type:'national'},
  {date:'2026-05-31', name:'‡∏ß‡∏¥‡∏™‡∏≤‡∏Ç‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},

  {date:'2026-06-01', name:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', type:'royal'},
  {date:'2026-06-03', name:'‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏†‡∏û ‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏™‡∏∏‡∏ó‡∏¥‡∏î‡∏≤', type:'royal'},

  {date:'2026-07-28', name:'‡∏ß‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏û‡∏£‡∏£‡∏©‡∏≤ ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 10', type:'royal'},
  {date:'2026-07-29', name:'‡∏≠‡∏≤‡∏™‡∏≤‡∏¨‡∏´‡∏ö‡∏π‡∏ä‡∏≤', type:'religion'},
  {date:'2026-07-30', name:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏£‡∏£‡∏©‡∏≤', type:'religion'},

  {date:'2026-08-12', name:'‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', type:'royal'},

  {date:'2026-10-13', name:'‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï ‡∏£.9', type:'royal'},
  {date:'2026-10-23', name:'‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏¢‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä', type:'royal'},

  {date:'2026-12-05', name:'‡∏ß‡∏±‡∏ô‡∏û‡πà‡∏≠‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', type:'royal'},
  {date:'2026-12-07', name:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', type:'royal'},
  {date:'2026-12-10', name:'‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç', type:'national'},
  {date:'2026-12-31', name:'‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ', type:'national'},
];

/* ‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î */
const HOLI_KEYWORDS = [
  "‡∏´‡∏¢‡∏∏‡∏î","‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î","‡∏ä‡∏î‡πÄ‡∏ä‡∏¢","‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà","‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå",
  "‡∏ß‡∏±‡∏ô‡∏û‡πà‡∏≠","‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà","‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡πá‡∏Å",
  "‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤","‡∏ß‡∏¥‡∏™‡∏≤‡∏Ç‡∏ö‡∏π‡∏ä‡∏≤","‡∏≠‡∏≤‡∏™‡∏≤‡∏¨‡∏´‡∏ö‡∏π‡∏ä‡∏≤","‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏£‡∏£‡∏©‡∏≤","‡∏≠‡∏≠‡∏Å‡∏û‡∏£‡∏£‡∏©‡∏≤",
  "‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç","‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô","‡∏õ‡∏¥‡∏¢‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä","‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏û‡∏£‡∏£‡∏©‡∏≤"
];

function isHolidayDate(d){
  const iso = localISODate(d);
  return HOLIDAYS.some(h => h.date === iso);
}
function getHolidayByDate(d){
  const iso = localISODate(d); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
  return HOLIDAYS.find(h => h.date === iso) || null;
}
function isHolidayEvent(e){
  const text = [e.title,e.details].join(" ").toLowerCase();
  return HOLI_KEYWORDS.some(k => text.includes(k.toLowerCase()));
}
/* ================= STATE ================= */
const STATE = {
  today: new Date(),
  cursor: new Date(),
  events: [],
  admin: { authed:false, currentId:null }
};
/* ================= STAFFS ================= */
const STAFF = [
  "‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå ‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì‡πå","‡∏ô‡∏≤‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ô‡∏†‡∏≤ ‡∏Ñ‡∏á‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏í‡∏ô‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ä‡∏•‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡∏≠‡∏£‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏á",
  "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡∏†‡∏≤‡∏û‡∏£ ‡∏£‡∏ß‡∏î‡∏ó‡∏£‡∏á","‡∏ô‡∏≤‡∏¢‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏±‡∏¢ ‡∏™‡∏≤‡∏£‡∏∞‡∏£‡∏±‡∏ï‡∏ô‡πå","‡∏ô‡∏≤‡∏¢‡∏®‡∏£‡∏≤‡∏¢‡∏∏‡∏ó‡∏ò ‡πÅ‡∏Å‡πâ‡∏ß‡∏ö‡∏±‡∏ö‡∏†‡∏≤",
  "‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ä‡∏±‡∏¢ ‡∏ò‡∏ô‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏ä‡∏±‡∏¢","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏£‡∏ô‡∏†‡∏≤ ‡πÄ‡∏ô‡∏≤‡∏ß‡∏∞‡πÄ‡∏®‡∏©","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏¥‡∏•‡∏≤‡∏™‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‡∏û‡∏•‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°",
  "‡∏ô‡∏≤‡∏¢‡∏ó‡∏ô‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏†‡∏π‡∏ï‡∏¥‡πÇ‡∏™","‡∏ô‡∏≤‡∏¢‡∏†‡∏π‡πÄ‡∏ö‡∏® ‡∏†‡∏π‡πÅ‡∏î‡∏ô‡πÑ‡∏Å‡∏•","‡∏ô‡∏≤‡∏¢‡∏à‡∏±‡∏Å‡∏£‡∏Å‡∏§‡∏© ‡∏´‡∏á‡∏©‡πå‡∏ä‡∏π‡∏ï‡∏≤",
  "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ä‡∏ô‡∏°‡∏≤‡∏® ‡πÄ‡∏ó‡∏®‡∏≤‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå","‡∏ô‡∏≤‡∏¢‡∏û‡∏á‡∏®‡∏ò‡∏£ ‡∏ß‡∏¥‡∏ä‡∏±‡∏¢‡∏ú‡∏¥‡∏ô","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏à‡∏¥‡∏£‡∏†‡∏±‡∏ó‡∏£ ‡πÄ‡∏ä‡∏ï‡∏∏‡∏£‡∏≤‡∏ä"
];

function fillStaffList(){
  const fromEvents = new Set();
  (STATE.events || []).forEach(e=>{
    String(e.owner||'')
      .split(',')
      .map(s=>s.trim())
      .filter(Boolean)
      .forEach(n=>fromEvents.add(n));
  });
  const options = Array.from(new Set([...STAFF, ...fromEvents]))
    .sort((a,b)=>a.localeCompare(b,'th'));
  $('#staffList').html(options.map(n=>`<option value="${n}">`).join(''));
}

/* ================= UTIL: Date/Thai ================= */
const thMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
function toBuddhistYearStr(d){
  const y = d.getFullYear()+543, m = thMonths[d.getMonth()], day = d.getDate();
  return `${day} ${m} ${y}`;
}
function yymmLabel(d){ return `${thMonths[d.getMonth()]} ${d.getFullYear()+543}`; }
function isSameDate(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
function localISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: YYYY-MM-DD, DD/MM/YYYY (‡∏û.‡∏®./‡∏Ñ.‡∏®.), Excel serial, Date
function parseAnyDate(v){
  if(!v) return null;
  if(v instanceof Date) return v;
  if(typeof v==='number'){
    const base = new Date(Date.UTC(1899,11,30)); // Excel 1900
    return new Date(base.getTime() + v*86400000);
  }
  if(typeof v==='string'){
    const s=v.trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const [Y,M,D]=s.split('-').map(Number);
      return new Date(Y,M-1,D);   // ‚úÖ ‡πÉ‡∏ä‡πâ Local Date
    }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
      let [D,M,Y]=s.split('/').map(Number);
      if(Y>2400) Y-=543;
      return new Date(Y,M-1,D);
    }
  }
  const d = new Date(v); return isNaN(d)?null:d;
}

function dayRangeArray(ev){
  const d = parseAnyDate(ev.date);
  const s = parseAnyDate(ev.startDate);
  const e = parseAnyDate(ev.endDate);
  if(d) return [d];
  if(s && e){ const arr=[]; let cur=new Date(s); while(cur<=e){arr.push(new Date(cur)); cur.setDate(cur.getDate()+1);} return arr; }
  if(s && !e) return [s];
  return [];
}

/* ================= DATA LAYER ================= */
async function fetchFromGAS(){
  try{
    const res = await fetch(GAS_ENDPOINT, {cache:'no-store'});
    const js  = await res.json();
    if(js && js.status==='ok') return js.data;
  }catch(e){ console.warn(e); }
  return null;
}
async function postToGAS(mode, payload){
  const res = await fetch(GAS_ENDPOINT, {method:'POST', headers:{'Content-Type':'text/plain; charset=utf-8' }, body:JSON.stringify({mode, payload})});
  return res.json();
}

function normalizeIncoming(rows){
  return (rows||[]).map(r=>({
    id: (r.id??'').toString(),
    title: r.title??'',
    date: r.date??'',
    startDate: r.startDate??'',
    endDate: r.endDate??'',
    startTime: r.startTime??'',
    endTime: r.endTime??'',
    location: r.location??'',
    owner: r.owner??'',
    details: r.details??'',
    emoji: r.emoji??''
  }));
}

function saveCache(data){ localStorage.setItem(CACHE_KEY, JSON.stringify(data)); localStorage.setItem(CACHE_AT, Date.now().toString()); }
function loadCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch{ return [] } }

/* ================= RENDER ================= */
function renderHeader(){ $('#currentMonthLabel').text(yymmLabel(STATE.cursor)); }

function blankCell(){ return `<div class="day" style="opacity:.35"></div>`; }

function eventsOnDate(d){
  const y=d.getFullYear(), m=d.getMonth(), day=d.getDate();
  return STATE.events.filter(e=> dayRangeArray(e).some(dd=> dd.getFullYear()===y && dd.getMonth()===m && dd.getDate()===day ));
}

function eventsInMonth(y,m){
  return STATE.events.filter(e=>eventTouchesYM(e,y,m)).sort((a,b)=>{
    const ad = parseAnyDate(a.date) || parseAnyDate(a.startDate) || new Date(9999,0,1);
    const bd = parseAnyDate(b.date) || parseAnyDate(b.startDate) || new Date(9999,0,1);
    return ad-bd;
  });
}

function eventTouchesYM(e,y,m){
  const d=parseAnyDate(e.date);
  const s=parseAnyDate(e.startDate);
  const en=parseAnyDate(e.endDate);
  if(d) return d.getFullYear()===y && d.getMonth()===m;
  if(s && en){
    const monthStart=new Date(y,m,1), monthEnd=new Date(y,m+1,0);
    const rangeStart=new Date(s.getFullYear(), s.getMonth(), 1);
    const rangeEnd=new Date(en.getFullYear(), en.getMonth()+1, 0);
    return rangeEnd>=monthStart && rangeStart<=monthEnd;
  }
  if(s) return s.getFullYear()===y && s.getMonth()===m;
  return false;
}

function timeLabel(e){
  if(e.startTime && e.endTime) return `${e.startTime}-${e.endTime}`;
  if(e.startTime) return e.startTime;
  return '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
}
function rangeLabel(e){
  const d=parseAnyDate(e.date), s=parseAnyDate(e.startDate), en=parseAnyDate(e.endDate);
  if(d) return toBuddhistYearStr(d);
  if(s && en) return `${toBuddhistYearStr(s)} ‚Äì ${toBuddhistYearStr(en)}`;
  if(s) return toBuddhistYearStr(s);
  return '';
}
function escapeHtml(t){ return (t??'').toString().replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

function dayCell(d){
  const isSun = d.getDay()===0, isSat = d.getDay()===6;

  // ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
  const evs = eventsOnDate(d);

  // ===== ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î =====
  const holObj = getHolidayByDate(d);      // {date,name,type} ‡∏´‡∏£‡∏∑‡∏≠ null
  const isHol  = !!holObj || evs.some(isHolidayEvent);

  // ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
  const has = evs.length > 0 || !!holObj;

  // ‡∏Ñ‡∏•‡∏≤‡∏™‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå (‡πÉ‡∏™‡πà‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢)
  const cellCls = [
    "day",
    isSun ? "sun" : "",
    isSat ? "sat" : "",
    (evs.length > 0) ? "has-event" : "",
    isHol ? "holiday"   : "",
    holObj && holObj.type ? `holiday--${holObj.type}` : ""
  ].filter(Boolean).join(" ");

  // ‡∏ä‡∏¥‡∏õ ‚Äú‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‚Äù (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
  const chipHoliday = holObj ? `
    <div class="chip" title="${holObj.name}">
      <span>üéå</span>
      <span>${holObj.name}</span>
      <span class="opacity-70">‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
    </div>` : "";

  // ‡∏ä‡∏¥‡∏õ‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ)
  const chipsDesktop = `
    ${chipHoliday}
    ${evs.map(e=>`
      <div class="chip" title="${escapeHtml(e.title)}">
        <span>${e.emoji || 'üóìÔ∏è'}</span>
        <span>${escapeHtml(e.title)}</span>
        <span class="opacity-70">‚Ä¢ ${timeLabel(e)}</span>
      </div>`).join('')}
  `;

  // ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ‡∏á‡∏≤‡∏ô + ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
  const countAll = evs.length + (holObj ? 1 : 0);
  const dotsMobile = has
    ? `<div class="mobile-dots" aria-label="‡∏°‡∏µ ${countAll} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
         <span class="dot"></span><span class="count-badge">${countAll}</span>
       </div>`
    : '';

  const todayBadge = isSameDate(d, STATE.today) ? `<span class="today-badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>` : '';

  // ‡πÉ‡∏ä‡πâ localISODate(d) ‡πÅ‡∏ó‡∏ô toISOString() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
  const isoLocal = localISODate(d);

  return `
<div class="${cellCls} day-cell"
     data-iso="${isoLocal}"
     onclick="openDayModal('${isoLocal}')"
     ondblclick="openAddFor('${isoLocal}')">
  ${todayBadge}
  <div class="num">${d.getDate()}</div>
  <div class="mt-6">
    ${chipsDesktop}
    ${dotsMobile}
    ${(!has && window.innerWidth > 480) ? `<div class="text-xs text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>` : ''}
  </div>
</div>`;
}

function listItem(e){
  const dateStr = rangeLabel(e);
  return `<div class="p-3 card">
    <div class="flex items-center gap-2 text-sky-700"><span class="text-xl">${e.emoji||'üóìÔ∏è'}</span><b>${escapeHtml(e.title)}</b></div>
    <div class="text-sm text-slate-600 mt-1">${dateStr}${e.startTime?` ‚Ä¢ ${e.startTime}`:''}${e.endTime?`‚Äì${e.endTime}`:''}</div>
    <div class="text-sm text-slate-600">${escapeHtml(e.location||'')}</div>
    <div class="text-sm text-slate-500">${escapeHtml(e.owner||'')}</div>
  </div>`;
}

function renderMonthGrid(){
  const y=STATE.cursor.getFullYear(), m=STATE.cursor.getMonth();
  const first=new Date(y,m,1), startDow=first.getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();

  const frag=[];
  for(let i=0;i<startDow;i++) frag.push(blankCell());
  for(let d=1; d<=daysInMonth; d++) frag.push(dayCell(new Date(y,m,d)));
  while(frag.length%7!==0) frag.push(blankCell());

  $('#monthGrid').html(frag.join(''));
  const monthEvents = eventsInMonth(y,m);
  $('#monthList').html(
    monthEvents.length > 0
      ? monthEvents.map(e=>listItem(e)).join('')
      : `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`
  );
}

function renderListView(){
  const years = [...new Set(STATE.events.flatMap(e=>{
    const ds=[parseAnyDate(e.date), parseAnyDate(e.startDate), parseAnyDate(e.endDate)].filter(Boolean);
    return ds.map(x=>x.getFullYear()+543);
  }))].sort((a,b)=>a-b);

  $('#filterYear').html(`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + years.map(y=>`<option>${y}</option>`).join(''));
  $('#filterMonth').html(`<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>` + thMonths.map((m,i)=>`<option value="${i}">${m}</option>`).join(''));

  applyListFilter();
}

function applyListFilter(){
  const q = ($('#searchInput').val()||'').toLowerCase();
  const m = $('#filterMonth').val();
  const y = $('#filterYear').val();
  let data = [...STATE.events];
  if(q) data = data.filter(e=>[e.title,e.details,e.location,e.owner].join(' ').toLowerCase().includes(q));
  if(y) data = data.filter(e=>eventTouchesYear(e, +y-543));
  if(m!=='') data = data.filter(e=>eventTouchesMonth(e, +m));
  $('#listContainer').html(
    data.length > 0
      ? data.map(listItem).join('')
      : `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`
  );
}

function renderYearView(){
  const year = STATE.cursor.getFullYear();
  const box = [];
  for(let m=0;m<12;m++){
    const label = `${thMonths[m]} ${year+543}`;
    const first=new Date(year,m,1), last=new Date(year,m+1,0), startDow=first.getDay();
    const head = `<div class="font-semibold mb-2 text-slate-700">${label}</div>`;
    const gridHead = `<div class="mini-7 mb-1 text-center text-xs text-slate-500"><div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div></div>`;
    let cells = [];
    for(let i=0;i<startDow;i++) cells.push(`<div class="card p-1 text-center text-xs opacity-30"></div>`);
    for(let d=1; d<=last.getDate(); d++){
      const dd=new Date(year,m,d);
      const has = eventsOnDate(dd).length>0;
      cells.push(`<div class="card p-1 text-center text-xs ${has?'bg-sky-50':''}">${d}</div>`);
    }
    box.push(`<div class="card p-3">${head}${gridHead}<div class="mini-7">${cells.join('')}</div></div>`);
  }
  $('#yearGrid').html(box.join(''));
}

function eventTouchesYear(e,year){
  const d=parseAnyDate(e.date), s=parseAnyDate(e.startDate), en=parseAnyDate(e.endDate);
  return [d,s,en].filter(Boolean).some(x=>x.getFullYear()===year);
}
function eventTouchesMonth(e,monthIdx){
  const d=parseAnyDate(e.date), s=parseAnyDate(e.startDate), en=parseAnyDate(e.endDate);
  return [d,s,en].filter(Boolean).some(x=>x.getMonth()===monthIdx);
}

/* ================= MODALS ================= */
function openDayModal(isoLocal){
  // isoLocal ‡πÄ‡∏ä‡πà‡∏ô "2025-04-06"
  const [y,m,d] = isoLocal.split('-').map(Number);
  const dateObj = new Date(y, m-1, d);   // ‚úÖ local date

  $('#modalDayTitle').text(`‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${toBuddhistYearStr(dateObj)}`);
  $('#modalDaySub').text(`‡∏ß‡∏±‡∏ô${['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'][dateObj.getDay()]}`);

  // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô + ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
  const evs = eventsOnDate(dateObj);
  const hol = getHolidayByDate(dateObj); // {date,name,type} ‡∏´‡∏£‡∏∑‡∏≠ null

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏• (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const items = [];
  if(hol){
    items.push(`
      <div class="card p-3">
        <div class="flex items-center gap-2 text-sky-700">
          <span class="text-xl">üéå</span><b>${hol.name}</b>
        </div>
        <div class="text-sm text-slate-600 mt-1">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</div>
      </div>
    `);
  }
  items.push(...evs.map(e=>`
      <div class="card p-3 cursor-pointer" onclick="openDetail('${e.id}')">
        <div class="flex items-center gap-2 text-sky-700">
          <span class="text-xl">${e.emoji||'üóìÔ∏è'}</span><b>${escapeHtml(e.title)}</b>
        </div>
        <div class="text-sm text-slate-600 mt-1">${rangeLabel(e)} ${timeLabel(e)}</div>
        <div class="text-sm text-slate-600">${escapeHtml(e.location||'')}</div>
      </div>
  `));

  $('#modalDayList').html(items.length ? items.join('') : `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`);
  $('#modal-day').addClass('show');
}
function closeDayModal(){ $('#modal-day').removeClass('show'); }
function openDetail(id){
  const e = STATE.events.find(x=>x.id===id); if(!e) return;
  $('#detailEmoji').text(e.emoji||'üóìÔ∏è');
  $('#detailTitle').text(e.title);
  $('#detailBody').html(`
    <div>üìÖ ${rangeLabel(e)} ${timeLabel(e)!=='‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'?`‚Ä¢ ${timeLabel(e)}`:''}</div>
    ${e.location?`<div>üìç ${escapeHtml(e.location)}</div>`:''}
    ${e.owner?`<div>üë§ ${escapeHtml(e.owner)}</div>`:''}
    ${e.details?`<div class="text-slate-600 mt-2">${escapeHtml(e.details)}</div>`:''}
  `);
  $('#btnEditInDetail').off().on('click',()=>{ closeDetailModal(); openAdmin('edit', id); });
  $('#btnDeleteInDetail').off().on('click',()=>{ closeDetailModal(); openAdmin('delete', id); });
  $('#detailAdminBtns').css('display', STATE.admin.authed?'flex':'none');
  $('#modal-detail').addClass('show');
}
function closeDetailModal(){ $('#modal-detail').removeClass('show'); }

/* ================= ADMIN ================= */
function openAdmin(tab='add', id=null){
  if(!STATE.admin.authed){
    Swal.fire({title:'‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', input:'password', inputAttributes:{autocapitalize:'off'}, showCancelButton:true, confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'})
      .then(res=>{
        if(res.isConfirmed){
          if(res.value===ADMIN_PASSWORD){
            STATE.admin.authed=true; $('#adminConn').text($('#connStatus').text());
            confetti({particleCount:80,spread:65});
            $('#modal-admin').addClass('show'); switchTab(tab); if(id) preloadFor(id);
          }else{
            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
          }
        }
      });
  }else{
    $('#modal-admin').addClass('show'); switchTab(tab); if(id) preloadFor(id);
  }
}
function closeAdminModal(){ $('#modal-admin').removeClass('show'); }

function switchTab(name){
  $('.tab').removeClass('active');
  $(`.tab[data-tab="${name}"]`).addClass('active');
  $('#tab-add,#tab-edit,#tab-delete').addClass('hidden');
  $(`#tab-${name}`).removeClass('hidden');
  if(name==='edit' || name==='delete') refreshAdminLists();
}

function preloadFor(id){
  refreshAdminLists(()=>{
    $('#edit-select').val(id).trigger('change');
    $('#delete-select').val(id);
  });
}
function openAddFor(iso){
  const d = new Date(iso);
  openAdmin('add');
  $('input[name="add-mode"][value="single"]').prop('checked', true).trigger('change');
  $('#add-date').val(d.toISOString().slice(0,10));
  $('#add-location').val('(‡πÑ‡∏°‡πà‡∏°‡∏µ)');
  $('#add-owner').val('');
  setTimeout(()=>$('#add-title').trigger('focus'), 0);
}
function refreshAdminLists(cb){
  const opts = STATE.events
    .map(e=>`<option value="${e.id}">${escapeHtml(e.title)} ‚Äî ${rangeLabel(e)}</option>`)
    .join('');
  $('#edit-select,#delete-select').html(opts || '<option value="">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</option>');

  $('#edit-select').off().on('change', function(){
    const id = $(this).val();
    const e  = STATE.events.find(x=>x.id===id);

    if(!e){ $('#edit-form').addClass('hidden'); return; }
    $('#edit-form').removeClass('hidden');

    // ===== ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô =====
    $('#edit-title').val(e.title);
    $('#edit-emoji').val(e.emoji || '');

    const single = !!e.date && !e.startDate && !e.endDate;
    $(`input[name="edit-mode"][value="${single?'single':'range'}"]`).prop('checked', true);
    $('#edit-single-wrap').toggleClass('hidden', !single);
    $('#edit-range-wrap').toggleClass('hidden',  single);

    $('#edit-date').val(dateForInput(e.date));
    $('#edit-startDate').val(dateForInput(e.startDate));
    $('#edit-endDate').val(dateForInput(e.endDate));
    $('#edit-startTime').val(e.startTime || '');
    $('#edit-endTime').val(e.endTime || '');
    $('#edit-location').val(e.location || '');

    // ===== ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô =====
    // ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö array ‡∏´‡∏£‡∏∑‡∏≠ string ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma
    const owners = Array.isArray(e.owner)
      ? e.owner
      : String(e.owner || '')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

    $('#edit-owner').val(owners.join(', '));

    STATE.admin.currentId = id;
  });

  if(cb) cb();
}

function dateForInput(v){
  const d = parseAnyDate(v); if(!d) return '';
  const m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
  return `${d.getFullYear()}-${m}-${dd}`;
}

function collectForm(prefix, mode){
  const v = (id)=>$(`#${prefix}-${id}`).val();
  const payload = {
    id:'', title:v('title'), emoji:v('emoji'),
    startTime:v('startTime'), endTime:v('endTime'),
    owner: v('owner'),
    location:v('location'), 
    details:v('details'),
    date:'', startDate:'', endDate:''
  };
  if(mode==='single'){ payload.date = v('date'); }
  else { payload.startDate = v('startDate'); payload.endDate = v('endDate'); }
  return payload;
}

/* ================= ACTIONS ================= */
$('#btnAddConfirm').on('click', async ()=>{
  const mode = $('input[name="add-mode"]:checked').val();
  const payload = collectForm('add', mode);
  if(!payload.id) payload.id = 'ev_'+Date.now();
  await doSave('add', payload);
});
$('#btnEditSave').on('click', async ()=>{
  const id = STATE.admin.currentId; if(!id) return;
  const mode = $('input[name="edit-mode"]:checked').val();
  const payload = collectForm('edit', mode); payload.id=id;
  await doSave('edit', payload);
});
$('#btnDeleteConfirm').on('click', async ()=>{
  const id = $('#delete-select').val(); if(!id) return;
  const ok = await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', text:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', icon:'warning', showCancelButton:true});
  if(ok.isConfirmed){ await doSave('delete', {id}); }
});

async function doSave(mode, payload){
  try{
    showLoading(true);
    const js = await postToGAS(mode, payload);
    if(js.status==='ok'){
      confetti({particleCount:120,spread:70});
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß','success');
      await synchronizeNow();
      $('#modal-admin').removeClass('show');
    }else{
      Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', js.message||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ','error');
    }
  }catch(e){
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', String(e.message||e), 'error');
  }finally{ showLoading(false); }
}

/* ================= LOADING ================= */
function showLoading(v){ 
  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
  // $('#loading').toggleClass('show', !!v); 
}

/* ================= SYNC & INIT ================= */
async function synchronizeNow(){
  try{
    showLoading(true);
    const online = await fetchFromGAS();
    if(online && Array.isArray(online)){
      $('#connStatus').text('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå').removeClass('text-red-500').addClass('text-green-600');
      STATE.events = normalizeIncoming(online);
      saveCache(STATE.events);
      confetti({particleCount:60,spread:60});
      Swal.fire({title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß',icon:'success',timer:1400,showConfirmButton:false});
    }else{
      $('#connStatus').text('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå').removeClass('text-green-600').addClass('text-red-500');
      STATE.events = loadCache();
      Swal.fire('‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå','‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','info');
    }
    renderAll();
  }catch(e){
    $('#connStatus').text('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå').removeClass('text-green-600').addClass('text-red-500');
    STATE.events = loadCache();
    renderAll();
  }finally{ showLoading(false); }
}

function renderAll(){
  renderHeader();
  renderMonthGrid();
  renderListView();
  renderYearView();
  $('#countAll').text(STATE.events.length);
  const cm=STATE.cursor.getMonth(), cy=STATE.cursor.getFullYear();
  $('#countMonth').text(eventsInMonth(cy,cm).length);
  $('#countToday').text(eventsOnDate(STATE.today).length);
  fillStaffList();
}

/* ================= UI BINDINGS ================= */
$('#btnPrev').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()-1); renderAll(); });
$('#btnNext').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()+1); renderAll(); });
$('#btnToday').on('click',()=>{ STATE.cursor = new Date(); renderAll(); });
$('#btnViewMonth').on('click',()=>{ $('#view-month').show(); $('#view-list,#view-year').hide(); });
$('#btnViewList').on('click',()=>{ $('#view-list').show(); $('#view-month,#view-year').hide(); });
$('#btnViewYear').on('click',()=>{ $('#view-year').show(); $('#view-month,#view-list').hide(); });
$('#btnSync').on('click', synchronizeNow);
$('#btnAdmin').on('click', ()=>openAdmin('add'));
$('#searchInput,#filterMonth,#filterYear').on('input change', applyListFilter);

// toggle add/edit mode sections
$('body').on('change','input[name="add-mode"]', function(){
  const m=this.value;
  $('#add-single-wrap').toggleClass('hidden', m!=='single');
  $('#add-range-wrap').toggleClass('hidden', m!=='range');
});
$('body').on('change','input[name="edit-mode"]', function(){
  const m=this.value;
  $('#edit-single-wrap').toggleClass('hidden', m!=='single');
  $('#edit-range-wrap').toggleClass('hidden', m!=='range');
});

// static dropdowns
function fillStaticOptions(){
  // Emoji ‡πÅ‡∏ö‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
let emojiHTML = `<option value="">(‡πÑ‡∏°‡πà‡∏°‡∏µ)</option>`;
for (const [group, list] of Object.entries(EMOJI_GROUPS)) {
  emojiHTML += `<optgroup label="${group}">`;
  emojiHTML += list.map(e => `<option value="${e}">${e}</option>`).join('');
  emojiHTML += `</optgroup>`;
}
$('#add-emoji,#edit-emoji').html(emojiHTML);

  // Location
  $('#locationList').html(
    LOCATIONS.map(s=>`<option value="${s}">`).join('')
  );
}
/* ===== Emoji Picker (Grid) ===== */

/* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à) */
const EMOJI_GROUP_LIST = [
  { key:'acad',  name:'‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',  items:['üéì','üìö','‚úèÔ∏è','üìù','üß™','üî¨','üßÆ','üß†','üñ•Ô∏è','üßëüèª‚Äçüè´','üìñ','üßæ'] },
  { key:'meet',  name:'‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°/‡πÅ‡∏à‡πâ‡∏á', items:['üì¢','üóìÔ∏è','üìÖ','üìå','üìç','üõéÔ∏è','üîî','üó£Ô∏è','ü§ù','üí¨'] },
  { key:'school',name:'‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', items:['üè´','üèÜ','üéØ','üé™','üéâ','üéä','üí°','üßπ','üß∞','üßØ'] },
  { key:'travel',name:'‡∏ó‡∏±‡∏®‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', items:['üöå','üöê','üöó','‚úàÔ∏è','‚õ∫','üèñÔ∏è','üó∫Ô∏è','üß≥'] },
  { key:'sport', name:'‡∏Å‡∏µ‡∏¨‡∏≤', items:['‚öΩ','üèÄ','üèê','üèÉ‚Äç‚ôÇÔ∏è','üèÉ‚Äç‚ôÄÔ∏è','üèÖ','ü•á','üèä‚Äç‚ôÇÔ∏è'] },
  { key:'alert', name:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', items:['‚ö†Ô∏è','üö®','‚è∞','‚åõ','üì£','üß≠'] },
  { key:'relig',  name:'‡∏®‡∏≤‡∏™‡∏ô‡∏≤', items:['üïç','üõï','üèõÔ∏è','üßß','üïØÔ∏è','ü™∑'] },
  { key:'misc',  name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ', items:['üíª','üß™','üß¨','üîß','üß±','üå±','üå§Ô∏è','üé®','üéµ'] }
];

let EMOJI_TARGET = null; // id ‡∏Ç‡∏≠‡∏á input/select ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤

// ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ -> ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (‡πÑ‡∏ß‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô)
const EMOJI_KEYWORDS = [
  {kw:['‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£','‡∏Ñ‡∏£‡∏π','‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'], group:'acad'},
  {kw:['‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°','‡πÅ‡∏à‡πâ‡∏á','‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®','‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'], group:'meet'},
  {kw:['‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡∏á‡∏≤‡∏ô'], group:'school'},
  {kw:['‡∏ó‡∏±‡∏®‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤','‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'], group:'travel'},
  {kw:['‡∏Å‡∏µ‡∏¨‡∏≤','‡πÅ‡∏Ç‡πà‡∏á','‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏µ‡∏¨‡∏≤'], group:'sport'},
  {kw:['‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏î‡πà‡∏ß‡∏ô','‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'], group:'alert'}
];

function openEmojiPicker(targetId){
  EMOJI_TARGET = targetId;
  $('#emojiPicker').addClass('show');
  lockBody(true);
  renderEmojiTabs();
  renderEmojiGrid(EMOJI_GROUP_LIST[0].key);
  $('#emojiSearch').val('');
}

function closeEmojiPicker(){
  $('#emojiPicker').removeClass('show');
  lockBody(false);
  EMOJI_TARGET = null;
}

function renderEmojiTabs(activeKey){
  const html = EMOJI_GROUP_LIST.map(g =>
    `<div class="emoji-tab ${g.key===activeKey?'active':''}" data-key="${g.key}">${g.name}</div>`
  ).join('');
  $('#emojiTabs').html(html);
  $('#emojiTabs .emoji-tab').off().on('click', function(){
    $('#emojiTabs .emoji-tab').removeClass('active');
    $(this).addClass('active');
    renderEmojiGrid($(this).data('key'));
  });
}

function renderEmojiGrid(groupKey){
  const group = EMOJI_GROUP_LIST.find(g=>g.key===groupKey) || EMOJI_GROUP_LIST[0];
  const html = group.items.map(e=>`<div class="emoji-item" data-emoji="${e}">${e}</div>`).join('');
  $('#emojiGrid').html(html);
  $('#emojiGrid .emoji-item').off().on('click', function(){
    const emo = $(this).data('emoji');

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô <select> -> select option ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á
    const $t = $('#'+EMOJI_TARGET);
    if($t.is('select')){
      if($t.find(`option[value="${emo}"]`).length===0){ $t.append(`<option value="${emo}">${emo}</option>`); }
      $t.val(emo).trigger('change');
    }else{
      $t.val(emo).trigger('input');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° preview
    $(`button[data-emoji-bind="${EMOJI_TARGET}"] .preview`).text(emo || '‚Äî');

    closeEmojiPicker();
  });
}

$('#emojiCloseBtn').on('click', closeEmojiPicker);

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
$('#emojiSearch').on('input', function(){
  const q = $(this).val().trim().toLowerCase();
  if(!q){ renderEmojiGrid($('.emoji-tab.active').data('key')); return; }

  // ‡πÄ‡∏î‡∏≤ group ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÑ‡∏ó‡∏¢
  let key = null;
  for(const m of EMOJI_KEYWORDS){
    if(m.kw.some(w => q.includes(w))){ key = m.group; break; }
  }
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
  const items = (key ? [EMOJI_GROUP_LIST.find(g=>g.key===key)] : EMOJI_GROUP_LIST)
    .filter(Boolean).flatMap(g => g.items);

  const uniq = [...new Set(items)];
  $('#emojiTabs .emoji-tab').removeClass('active');
  const html = uniq.map(e=>`<div class="emoji-item" data-emoji="${e}">${e}</div>`).join('');
  $('#emojiGrid').html(html);
  $('#emojiGrid .emoji-item').off().on('click', function(){
    const emo = $(this).data('emoji');
    const $t = $('#'+EMOJI_TARGET);
    if($t.is('select')){
      if($t.find(`option[value="${emo}"]`).length===0){ $t.append(`<option value="${emo}">${emo}</option>`); }
      $t.val(emo).trigger('change');
    }else{
      $t.val(emo).trigger('input');
    }
    $(`button[data-emoji-bind="${EMOJI_TARGET}"] .preview`).text(emo || '‚Äî');
    closeEmojiPicker();
  });
});

/* ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö add-emoji / edit-emoji ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà) */
function attachEmojiPicker(fieldId){
  const $sel = $('#'+fieldId);
  // ‡∏ã‡πà‡∏≠‡∏ô select ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
  $sel.hide();

  const btn = $(`
    <button type="button" class="btn emoji-trigger" data-emoji-bind="${fieldId}">
      <span class="preview">${$sel.val()||'‚Äî'}</span>
      <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‚Ä¶</span>
    </button>
  `);
  $sel.after(btn);

  btn.on('click', ()=> openEmojiPicker(fieldId));
}
/* ================= CONFIG ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° ================= */
// 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
const ANNOUNCEMENT_TEXT = "üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà! | üìÖ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ‡∏ô‡∏∞‡∏Ñ‡∏∞ | üò∑ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢‡∏à‡∏≤‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";

// 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤)
const COUNTDOWN_TARGET = "2026-01-01T00:00:00"; // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà
const COUNTDOWN_TITLE  = "‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏™‡∏π‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569 üéâ";

function initExtras(){
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á
  $('#announceText').text(ANNOUNCEMENT_TEXT);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
  $('#cdTitle').text(COUNTDOWN_TITLE);
  
  const target = new Date(COUNTDOWN_TARGET).getTime();
  
  setInterval(()=>{
    const now = new Date().getTime();
    const diff = target - now;
    
    if(diff < 0){
      // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
      $('#cd-d,#cd-h,#cd-m,#cd-s').text('0');
      return;
    }

    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((diff % (1000 * 60)) / 1000);

    $('#cd-d').text(d);
    $('#cd-h').text(h);
    $('#cd-m').text(m);
    $('#cd-s').text(s);
  }, 1000);
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
$(document).ready(initExtras);
/* ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß */
/* START */
(async function init(){
  fillStaticOptions();
  attachEmojiPicker('add-emoji');
  attachEmojiPicker('edit-emoji');
  STATE.events = loadCache();
  renderAll();
  await synchronizeNow();
})();
</script>
</body>
</html>
